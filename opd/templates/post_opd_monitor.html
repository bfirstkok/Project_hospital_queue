<!doctype html>
<html lang="th">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Patient Monitor (‡∏´‡∏•‡∏±‡∏á OPD)</title>
  <link rel="stylesheet" href="{% static 'css/post_opd.css' %}?v=1">
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title pill-title">
      <div class="icon">üì°</div>
      <div>
        <h1>Patient Monitor (FOLLOWUP)</h1>
        <div class="subtitle">‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Äú‡∏ï‡∏£‡∏ß‡∏à OPD ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FOLLOWUP</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn" href="/queues/">üìãQueue</a>
      <a class="btn" href="/opd/">ü©∫OPD</a>
      <span class="pill mono" id="serverTime">--</span>
    </div>
  </div>

  <div class="card span12">
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Visit</th>
            <th class="col-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
            <th style="width:110px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th style="width:140px">Device</th>
            <th style="width:70px">BPM</th>
            <th style="width:70px">O2</th>
            <th style="width:70px">BT</th>
            <th style="width:90px">SYS/DIA</th>
            <th style="width:70px">RR</th>
            <th style="width:170px">Created</th>
            <th style="width:220px">Action</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="11" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const API_URL = "/queues/monitor/api/latest/";
  const DETAIL_URL = (visitId) => `/queues/monitor/visit/${visitId}/`;

  function fmt(v){
    return (v === null || v === undefined || v === "") ? "-" : v;
  }

  async function load() {
    const tbody = document.getElementById("rows");

    try {
      const res = await fetch(API_URL, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      document.getElementById("serverTime").textContent =
        data.server_time || "--";

      const rows = data.rows || [];
      if (!rows.length) {
        tbody.innerHTML =
          `<tr><td colspan="11" class="muted">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ FOLLOWUP (‡∏ï‡∏£‡∏ß‡∏à OPD ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
          </td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const vit = r.vitals || {};
        const status = r.online
          ? `<span class="online">ONLINE</span>`
          : `<span class="offline">OFFLINE</span>`;
        const created = r.created_at
          ? new Date(r.created_at).toLocaleString()
          : "-";
        const device =
          (r.device_id && String(r.device_id).trim())
            ? r.device_id
            : "DEV001";

        return `
          <tr>
            <td>#${r.visit_id}</td>

            <td class="col-name">
              <div style="font-weight:900">${r.name}</div>
              <div class="muted">
                FOLLOWUP Queue: ${fmt(r.followup_queue_id)}
              </div>
            </td>

            <td>${status}</td>
            <td class="mono">${fmt(device)}</td>
            <td>${fmt(vit.bpm)}</td>
            <td>${fmt(vit.o2sat)}</td>
            <td>${fmt(vit.bt)}</td>
            <td>${fmt(vit.sys_bp)}/${fmt(vit.dia_bp)}</td>
            <td>${fmt(vit.rr)}</td>
            <td class="muted">${created}</td>

            <td class="td-action">
              <a class="btn" href="${DETAIL_URL(r.visit_id)}">
                üîé ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </a>
            </td>
          </tr>
        `;
      }).join("");

    } catch (e) {
      tbody.innerHTML =
        `<tr><td colspan="11" class="muted">
          ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${e.message || e}
        </td></tr>`;
    }
  }

  load();
  setInterval(load, 5000);
</script>


</body>
</html>
