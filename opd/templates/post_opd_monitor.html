<!doctype html>
<html lang="th">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Patient Monitor (‡∏´‡∏•‡∏±‡∏á OPD)</title>
  <link rel="stylesheet" href="{% static 'css/queue_list.css' %}?v=1">
  <style>
    .online { color: #16a34a; font-weight: 800; }
    .offline { color: #dc2626; font-weight: 800; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .row-click { cursor:pointer; }
    .td-action { cursor: default; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title pill-title">
      <div class="icon">üì°</div>
      <div>
        <h1>Patient Monitor (FOLLOWUP)</h1>
        <div class="subtitle">‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Äú‡∏ï‡∏£‡∏ß‡∏à OPD ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FOLLOWUP</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn" href="/queues/">üìã ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</a>
      <a class="btn" href="/opd/">ü©∫ ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ OPD</a>
      <span class="pill mono" id="serverTime">--</span>
    </div>
  </div>

  <div class="card span12">
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Visit</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
            <th style="width:110px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th style="width:140px">Device</th>
            <th style="width:70px">BPM</th>
            <th style="width:70px">O2</th>
            <th style="width:70px">BT</th>
            <th style="width:90px">SYS/DIA</th>
            <th style="width:70px">RR</th>
            <th style="width:170px">Created</th>
            <th style="width:220px">Action</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="11" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ‚úÖ absolute path ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô URL
  const API_URL = "/queues/monitor/api/latest/";

  // ‚úÖ routes ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô queues/urls.py
  const DETAIL_URL = (visitId) => `/queues/monitor/visit/${visitId}/`;
  const DEMO_PUSH_URL = (visitId) => `/queues/monitor/demo/push/${visitId}/`;

  function fmt(v){ return (v === null || v === undefined || v === "") ? "-" : v; }

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ detail ‡πÅ‡∏ï‡πà "‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô" ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô action / a / button
  function rowClickHandler(ev, visitId) {
    const t = ev.target;
    if (!t) return;

    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå/‡∏õ‡∏∏‡πà‡∏°/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà action ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà redirect
    if (t.closest("a") || t.closest("button") || t.closest(".td-action") || t.closest(".actions")) {
      return;
    }
    location.href = DETAIL_URL(visitId);
  }

  

  async function load() {
    const tbody = document.getElementById("rows");

    try {
      const res = await fetch(API_URL, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      document.getElementById("serverTime").textContent = data.server_time || "--";

      const rows = data.rows || [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ FOLLOWUP (‡∏ï‡∏£‡∏ß‡∏à OPD ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const vit = r.vitals || {};
        const status = r.online ? `<span class="online">ONLINE</span>` : `<span class="offline">OFFLINE</span>`;
        const created = r.created_at ? new Date(r.created_at).toLocaleString() : "-";
        const device = (r.device_id && String(r.device_id).trim()) ? r.device_id : "DEV001";

        return `
          <tr class="row-click" onclick="rowClickHandler(event, ${r.visit_id})">
            <td>#${r.visit_id}</td>
            <td>
              <div style="font-weight:900">${r.name}</div>
              <div class="muted">FOLLOWUP Queue: ${fmt(r.followup_queue_id)}</div>
            </td>
            <td>${status}</td>
            <td class="mono">${fmt(device)}</td>
            <td>${fmt(vit.bpm)}</td>
            <td>${fmt(vit.o2sat)}</td>
            <td>${fmt(vit.bt)}</td>
            <td>${fmt(vit.sys_bp)}/${fmt(vit.dia_bp)}</td>
            <td>${fmt(vit.rr)}</td>
            <td class="muted">${created}</td>
            <td class="td-action">
              <div class="actions">
                <a class="btn" href="${DETAIL_URL(r.visit_id)}">üîé ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>

        
              </div>
            </td>
          </tr>
        `;
      }).join("");

    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="11" class="muted">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${e.message || e}</td></tr>`;
    }
  }

  load();
  setInterval(load, 5000);
</script>

</body>
</html>
